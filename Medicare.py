import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes,
    ConversationHandler,
    CallbackQueryHandler
)
from geopy.distance import geodesic

# --- Configuration ---
BOT_TOKEN = "7270460184:AAG2Btncm-5ybcXTsOhNpX6AytamVHCK5kA"

# Enable logging
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# --- Data & Localization ---
# A simple database of hospitals in Assam (lat, lon). Expand this list for a real application.
HOSPITALS = {
    "Gauhati Medical College and Hospital (GMCH)": (26.1433, 91.7898),
    "Assam Medical College and Hospital (AMCH), Dibrugarh": (27.4628, 94.9120),
    "Silchar Medical College and Hospital (SMCH)": (24.7826, 92.7938),
    "Fakhruddin Ali Ahmed Medical College, Barpeta": (26.3315, 91.0028),
}

# Text for multi-language support (English and Assamese)
TEXTS = {
    'en': {
        'welcome': "Welcome! Please choose your language.",
        'menu_intro': "How can I assist you today? Please choose an option:",
        'first_aid_prompt': "Please select a topic for first-aid guidance:",
        'find_hospital_prompt': "Please share your location to find nearby hospitals.",
        'share_location_btn': "Share My Location",
        'location_received': "Thank you. Searching for nearby hospitals...",
        'no_hospitals_found': "Sorry, I couldn't find any registered hospitals nearby.",
        'nearby_hospitals_header': "Here are the nearest hospitals:",
        'book_intro': "Let's schedule a free tele-consultation. What is the patient's full name?",
        'ask_age': "Got it. What is the patient's age?",
        'ask_symptoms': "Thank you. Please briefly describe the symptoms.",
        'booking_confirmed': "Thank you! Your consultation is tentatively booked. A representative will contact you soon to confirm the time.\n\nName: {name}\nAge: {age}\nSymptoms: {symptoms}",
        'booking_cancelled': "Booking cancelled.",
        'disclaimer': "‚ö†Ô∏è DISCLAIMER: This is an informational bot and not a substitute for professional medical advice. In case of an emergency, please contact your nearest hospital immediately."
    },
    'as': {
        'welcome': "‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡ß∞‡¶π ‡¶ï‡ß∞‡¶ø ‡¶Ü‡¶™‡ßã‡¶®‡¶æ‡ß∞ ‡¶≠‡¶æ‡¶∑‡¶æ ‡¶¨‡¶æ‡¶õ‡¶®‡¶ø ‡¶ï‡ß∞‡¶ï‡•§",
        'menu_intro': "‡¶Æ‡¶á ‡¶Ü‡¶™‡ßã‡¶®‡¶æ‡¶ï ‡¶ï‡ßá‡¶®‡ßá‡¶¶‡ß∞‡ßá ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º ‡¶ï‡ß∞‡¶ø‡¶¨ ‡¶™‡¶æ‡ß∞‡ßã‡¶Å? ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡ß∞‡¶π ‡¶ï‡ß∞‡¶ø ‡¶è‡¶ü‡¶æ ‡¶¨‡¶ø‡¶ï‡¶≤‡ßç‡¶™ ‡¶¨‡¶æ‡¶õ‡¶®‡¶ø ‡¶ï‡ß∞‡¶ï:",
        'first_aid_prompt': "‡¶™‡ßç‡ß∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡ß∞ ‡¶¨‡¶æ‡¶¨‡ßá ‡¶è‡¶ü‡¶æ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶¨‡¶æ‡¶õ‡¶®‡¶ø ‡¶ï‡ß∞‡¶ï:",
        'find_hospital_prompt': "‡¶ì‡¶ö‡ß∞‡ß∞ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶≤‡¶Ø‡¶º ‡¶¨‡¶ø‡¶ö‡¶æ‡ß∞‡¶ø‡¶¨‡¶≤‡ßà ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡ß∞‡¶π ‡¶ï‡ß∞‡¶ø ‡¶Ü‡¶™‡ßã‡¶®‡¶æ‡ß∞ ‡¶Ö‡ß±‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶∂‡ßç‡¶¨‡ßá‡¶Ø‡¶º‡¶æ‡ß∞ ‡¶ï‡ß∞‡¶ï‡•§",
        'share_location_btn': "‡¶Æ‡ßã‡ß∞ ‡¶Ö‡ß±‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶∂‡ßç‡¶¨‡ßá‡¶Ø‡¶º‡¶æ‡ß∞ ‡¶ï‡ß∞‡¶ï",
        'location_received': "‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶‡•§ ‡¶ì‡¶ö‡ß∞‡ß∞ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶≤‡¶Ø‡¶º‡¶∏‡¶Æ‡ßÇ‡¶π ‡¶¨‡¶ø‡¶ö‡ß∞‡¶æ ‡¶π‡ßà‡¶õ‡ßá...",
        'no_hospitals_found': "‡∞ï‡±ç‡∞∑‡¶Æ‡¶æ ‡¶ï‡ß∞‡¶ø‡¶¨, ‡¶Æ‡¶á ‡¶ì‡¶ö‡ß∞‡¶§ ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶û‡ßç‡¶ú‡ßÄ‡¶≠‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶≤‡¶Ø‡¶º ‡¶¨‡¶ø‡¶ö‡¶æ‡ß∞‡¶ø ‡¶®‡¶æ‡¶™‡¶æ‡¶≤‡ßã‡•§",
        'nearby_hospitals_header': "‡¶á‡¶Ø‡¶º‡¶æ‡¶§ ‡¶ì‡¶ö‡ß∞‡ß∞ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶≤‡¶Ø‡¶º‡¶∏‡¶Æ‡ßÇ‡¶π ‡¶Ü‡¶õ‡ßá:",
        'book_intro': "‡¶Ü‡¶π‡¶ï ‡¶è‡¶ü‡¶æ ‡¶¨‡¶ø‡¶®‡¶æ‡¶Æ‡ßÇ‡¶≤‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶ü‡ßá‡¶≤‡¶ø-‡¶™‡ß∞‡¶æ‡¶Æ‡ß∞‡ßç‡¶∂‡ß∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡ß∞‡ßç‡¶ß‡¶æ‡ß∞‡¶£ ‡¶ï‡ß∞‡ßã‡¶Å‡•§ ‡ß∞‡ßã‡¶ó‡ßÄ‡ß∞ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡ß∞‡ßç‡¶£ ‡¶®‡¶æ‡¶Æ ‡¶ï‡¶ø?",
        'ask_age': "‡¶¨‡ßÅ‡¶ú‡¶ø‡¶õ‡ßã‡•§ ‡ß∞‡ßã‡¶ó‡ßÄ‡ß∞ ‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶ï‡¶ø‡¶Æ‡¶æ‡¶®?",
        'ask_symptoms': "‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡ß∞‡¶π ‡¶ï‡ß∞‡¶ø ‡¶≤‡¶ï‡ßç‡¶∑‡¶£‡¶∏‡¶Æ‡ßÇ‡¶π ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™‡ßá ‡¶¨‡ß∞‡ßç‡¶£‡¶®‡¶æ ‡¶ï‡ß∞‡¶ï‡•§",
        'booking_confirmed': "‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶! ‡¶Ü‡¶™‡ßã‡¶®‡¶æ‡ß∞ ‡¶™‡ß∞‡¶æ‡¶Æ‡ß∞‡ßç‡¶∂‡ß∞ ‡¶¨‡¶æ‡¶¨‡ßá ‡¶Ö‡¶®‡ßÅ‡ß∞‡ßã‡¶ß ‡¶ó‡ßç‡ß∞‡¶π‡¶£ ‡¶ï‡ß∞‡¶æ ‡¶π‡ßà‡¶õ‡ßá‡•§ ‡¶Ü‡¶Æ‡¶æ‡ß∞ ‡¶™‡ßç‡ß∞‡¶§‡¶ø‡¶®‡¶ø‡¶ß‡¶ø‡ßü‡ßá ‡¶∏‡ßã‡¶®‡¶ï‡¶æ‡¶≤‡ßá‡¶á ‡¶Ü‡¶™‡ßã‡¶®‡¶æ‡¶ï ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡ß∞‡¶ø‡¶¨‡¶≤‡ßà ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡ß∞‡¶ø‡¶¨‡•§\n\n‡¶®‡¶æ‡¶Æ: {name}\n‡¶¨‡¶Ø‡¶º‡¶∏: {age}\n‡¶≤‡¶ï‡ßç‡¶∑‡¶£: {symptoms}",
        'booking_cancelled': "‡¶¨‡ßÅ‡¶ï‡¶ø‡¶Ç ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡ß∞‡¶æ ‡¶π'‡¶≤‡•§",
        'disclaimer': "‚ö†Ô∏è ‡¶¶‡¶æ‡¶¨‡¶ø‡¶§‡ßç‡¶Ø‡¶æ‡¶ó: ‡¶è‡¶á‡¶ü‡ßã ‡¶è‡¶ü‡¶æ ‡¶§‡¶•‡ßç‡¶Ø‡¶Æ‡ßÇ‡¶≤‡¶ï ‡¶¨‡¶ü ‡¶Ü‡ß∞‡ßÅ ‡¶™‡ßá‡¶õ‡¶æ‡¶¶‡¶æ‡ß∞‡ßÄ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶™‡ß∞‡¶æ‡¶Æ‡ß∞‡ßç‡¶∂‡ß∞ ‡¶¨‡¶ø‡¶ï‡¶≤‡ßç‡¶™ ‡¶®‡¶π‡¶Ø‡¶º‡•§ ‡¶ú‡ß∞‡ßÅ‡ß∞‡ßÄ‡¶ï‡¶æ‡¶≤‡ßÄ‡¶® ‡¶Ö‡ß±‡¶∏‡ßç‡¶•‡¶æ‡¶§, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡ß∞‡¶π ‡¶ï‡ß∞‡¶ø ‡¶ì‡¶ö‡ß∞‡ß∞ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶≤‡¶Ø‡¶º‡¶§ ‡¶∏‡ßã‡¶®‡¶ï‡¶æ‡¶≤‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡ß∞‡¶ï‡•§"
    }
}
# First aid data (keep it simple and verified)
FIRST_AID_DATA = {
    'en': {
        'fever': "Fever: 1. Rest. 2. Drink plenty of fluids. 3. Use a cool cloth on the forehead. 4. If fever is high or persists, see a doctor.",
        'burn': "Minor Burn: 1. Cool the burn under cool running water for 10-15 minutes. 2. Cover with a sterile bandage. 3. Do not apply ice or butter. For severe burns, seek medical help immediately.",
        'cut': "Minor Cut: 1. Apply gentle pressure with a clean cloth to stop bleeding. 2. Clean the wound with water. 3. Apply an antiseptic and cover with a sterile bandage."
    },
    'as': {
        'fever': "‡¶ú‡ßç‡¶¨‡ß∞: ‡ßß. ‡¶ú‡¶ø‡ß∞‡¶£‡¶ø ‡¶≤‡¶ì‡¶ï‡•§ ‡ß®. ‡¶™‡ßç‡ß∞‡¶ö‡ßÅ‡ß∞ ‡¶™‡ß∞‡¶ø‡¶Æ‡¶æ‡¶£‡ßá ‡¶™‡¶æ‡¶®‡ßÄ ‡¶ñ‡¶æ‡¶ì‡¶ï‡•§ ‡ß©. ‡¶ï‡¶™‡¶æ‡¶≤‡¶§ ‡¶†‡¶æ‡¶£‡ßç‡¶°‡¶æ ‡¶ï‡¶æ‡¶™‡ßã‡ß∞ ‡¶¶‡¶ø‡¶Ø‡¶º‡¶ï‡•§ ‡ß™. ‡¶Ø‡¶¶‡¶ø ‡¶ú‡ßç‡¶¨‡ß∞ ‡¶¨‡ßá‡¶õ‡¶ø ‡¶π‡¶Ø‡¶º ‡¶¨‡¶æ ‡¶®‡ßá‡ß∞‡ßá, ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶ï‡ß∞ ‡¶™‡ß∞‡¶æ‡¶Æ‡ß∞‡ßç‡¶∂ ‡¶≤‡¶ì‡¶ï‡•§",
        'burn': "‡¶∏‡ß∞‡ßÅ ‡¶™‡ßã‡ß∞‡¶æ: ‡ßß. ‡¶™‡ßã‡ß∞‡¶æ ‡¶†‡¶æ‡¶á‡¶ñ‡¶ø‡¶®‡¶ø ‡ßß‡ß¶-‡ßß‡ß´ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶†‡¶æ‡¶£‡ßç‡¶°‡¶æ ‡¶™‡¶æ‡¶®‡ßÄ‡ß∞ ‡¶§‡¶≤‡¶§ ‡ß∞‡¶æ‡¶ñ‡¶ï‡•§ ‡ß®. ‡¶¨‡ßÄ‡¶ú‡¶æ‡¶£‡ßÅ‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶¨‡ßá‡¶£‡ßç‡¶°‡ßá‡¶ú‡ß∞‡ßá ‡¶¢‡¶æ‡¶ï‡¶ø ‡¶¶‡¶ø‡¶Ø‡¶º‡¶ï‡•§ ‡ß©. ‡¶¨‡ß∞‡¶´ ‡¶¨‡¶æ ‡¶Æ‡¶æ‡¶ñ‡¶® ‡¶®‡¶æ‡¶≤‡¶ó‡¶æ‡¶¨‡•§ ‡¶ó‡ßÅ‡ß∞‡ßÅ‡¶§‡ß∞‡¶≠‡¶æ‡ß±‡ßá ‡¶™‡ßÅ‡ß∞‡¶ø‡¶≤‡ßá ‡¶§‡ßé‡¶ï‡¶æ‡¶≤‡ßÄ‡¶®‡¶≠‡¶æ‡ß±‡ßá ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶ï‡ß∞ ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º ‡¶≤‡¶ì‡¶ï‡•§",
        'cut': "‡¶∏‡ß∞‡ßÅ ‡¶ï‡¶ü‡¶æ: ‡ßß. ‡¶§‡ßá‡¶ú ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡ß∞‡¶ø‡¶¨‡¶≤‡ßà ‡¶™‡ß∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡ß∞ ‡¶ï‡¶æ‡¶™‡ßã‡ß∞‡ßá‡ß∞‡ßá ‡¶≤‡¶æ‡¶π‡ßá‡¶ï‡ßà ‡¶π‡ßá‡¶Å‡¶ö‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡¶ï‡•§ ‡ß®. ‡¶ò‡¶æ ‡¶ü‡ßÅ‡¶ï‡ßÅ‡ß∞‡¶æ ‡¶™‡¶æ‡¶®‡ßÄ‡ß∞‡ßá ‡¶ö‡¶æ‡¶´‡¶æ ‡¶ï‡ß∞‡¶ï‡•§ ‡ß©. ‡¶è‡¶®‡ßç‡¶ü‡¶ø‡¶ö‡ßá‡¶™‡ßç‡¶ü‡¶ø‡¶ï ‡¶≤‡¶ó‡¶æ‡¶á ‡¶¨‡ßÄ‡¶ú‡¶æ‡¶£‡ßÅ‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶¨‡ßá‡¶£‡ßç‡¶°‡ßá‡¶ú‡ßá‡ß∞‡ßá ‡¶¢‡¶æ‡¶ï‡¶ø ‡¶¶‡¶ø‡¶Ø‡¶º‡¶ï‡•§"
    }
}

# --- Conversation States for Booking ---
SELECTING_ACTION, BOOKING_NAME, BOOKING_AGE, BOOKING_SYMPTOMS = range(4)

# --- Bot Functions ---

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Displays language selection on /start."""
    keyboard = [
        [InlineKeyboardButton("English", callback_data='lang_en')],
        [InlineKeyboardButton("‡¶Ö‡¶∏‡¶Æ‡ßÄ‡¶Ø‡¶º‡¶æ (Assamese)", callback_data='lang_as')],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(TEXTS['en']['welcome'], reply_markup=reply_markup)

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Handles all button presses."""
    query = update.callback_query
    await query.answer()
    lang = context.user_data.get('lang', 'en') # Default to English

    # Language selection
    if query.data.startswith('lang_'):
        lang = query.data.split('_')[1]
        context.user_data['lang'] = lang
        await query.edit_message_text(text=TEXTS[lang]['disclaimer'])
        await show_main_menu(update, context)
        return SELECTING_ACTION

    # First Aid Topic selection
    if query.data.startswith('aid_'):
        topic = query.data.split('_')[1]
        await query.edit_message_text(text=FIRST_AID_DATA[lang][topic])
        await show_main_menu(update, context) # Show menu again
        return SELECTING_ACTION
    
    return SELECTING_ACTION


async def show_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Displays the main menu keyboard."""
    lang = context.user_data.get('lang', 'en')
    keyboard = [
        [KeyboardButton("‚öïÔ∏è " + ("First-Aid Tips" if lang == 'en' else "‡¶™‡ßç‡ß∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ"))],
        [KeyboardButton("üè• " + ("Find Nearby Hospital" if lang == 'en' else "‡¶ì‡¶ö‡ß∞‡ß∞ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶≤‡¶Ø‡¶º ‡¶¨‡¶ø‡¶ö‡¶æ‡ß∞‡¶ï"))],
        [KeyboardButton("üìÖ " + ("Book Tele-consultation" if lang == 'en' else "‡¶ü‡ßá‡¶≤‡¶ø-‡¶™‡ß∞‡¶æ‡¶Æ‡ß∞‡ßç‡¶∂ ‡¶¨‡ßÅ‡¶ï ‡¶ï‡ß∞‡¶ï"))],
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=True)
    
    # If it's a callback query, send a new message. If it's a regular message, reply to it.
    if update.callback_query:
        await context.bot.send_message(chat_id=update.effective_chat.id, text=TEXTS[lang]['menu_intro'], reply_markup=reply_markup)
    else:
        await update.message.reply_text(TEXTS[lang]['menu_intro'], reply_markup=reply_markup)


async def handle_text_choice(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handles text choices from the main menu."""
    text = update.message.text
    if "First-Aid" in text or "‡¶™‡ßç‡ß∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ" in text:
        return await first_aid(update, context)
    if "Find Nearby Hospital" in text or "‡¶ì‡¶ö‡ß∞‡ß∞ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶≤‡¶Ø‡¶º ‡¶¨‡¶ø‡¶ö‡¶æ‡ß∞‡¶ï" in text:
        return await find_hospital_start(update, context)
    if "Book Tele-consultation" in text or "‡¶ü‡ßá‡¶≤‡¶ø-‡¶™‡ß∞‡¶æ‡¶Æ‡ß∞‡ßç‡¶∂ ‡¶¨‡ßÅ‡¶ï ‡¶ï‡ß∞‡¶ï" in text:
        return await book_start(update, context)


async def first_aid(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Shows first-aid options."""
    lang = context.user_data.get('lang', 'en')
    keyboard = [
        [InlineKeyboardButton("Fever / ‡¶ú‡ßç‡¶¨‡ß∞", callback_data='aid_fever')],
        [InlineKeyboardButton("Minor Burn / ‡¶∏‡ß∞‡ßÅ ‡¶™‡ßã‡ß∞‡¶æ", callback_data='aid_burn')],
        [InlineKeyboardButton("Minor Cut / ‡¶∏‡ß∞‡ßÅ ‡¶ï‡¶ü‡¶æ", callback_data='aid_cut')],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(TEXTS[lang]['first_aid_prompt'], reply_markup=reply_markup)

async def find_hospital_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Asks for user's location."""
    lang = context.user_data.get('lang', 'en')
    keyboard = [[KeyboardButton(TEXTS[lang]['share_location_btn'], request_location=True)]]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=True)
    await update.message.reply_text(TEXTS[lang]['find_hospital_prompt'], reply_markup=reply_markup)

async def location_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Receives user location and finds nearest hospitals."""
    lang = context.user_data.get('lang', 'en')
    user_location = (update.message.location.latitude, update.message.location.longitude)
    await update.message.reply_text(TEXTS[lang]['location_received'])

    distances = []
    for name, coords in HOSPITALS.items():
        dist = geodesic(user_location, coords).km
        distances.append((dist, name, coords))

    distances.sort() # Sort by distance, ascending

    if not distances:
        await update.message.reply_text(TEXTS[lang]['no_hospitals_found'])
        return

    response = TEXTS[lang]['nearby_hospitals_header'] + "\n\n"
    for dist, name, coords in distances[:3]: # Show top 3
        maps_link = f"https://www.google.com/maps/search/?api=1&query={coords[0]},{coords[1]}"
        response += f"üè• *{name}*\n"
        response += f"   - Distance: {dist:.2f} km\n"
        response += f"   - [Open in Maps]({maps_link})\n\n"
        
    await update.message.reply_markdown(response, disable_web_page_preview=True)
    await show_main_menu(update, context)

async def book_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Starts the booking conversation."""
    lang = context.user_data.get('lang', 'en')
    await update.message.reply_text(TEXTS[lang]['book_intro'])
    return BOOKING_NAME

async def book_name(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Stores name and asks for age."""
    context.user_data['booking_name'] = update.message.text
    lang = context.user_data.get('lang', 'en')
    await update.message.reply_text(TEXTS[lang]['ask_age'])
    return BOOKING_AGE

async def book_age(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Stores age and asks for symptoms."""
    context.user_data['booking_age'] = update.message.text
    lang = context.user_data.get('lang', 'en')
    await update.message.reply_text(TEXTS[lang]['ask_symptoms'])
    return BOOKING_SYMPTOMS

async def book_symptoms(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Stores symptoms and confirms booking."""
    context.user_data['booking_symptoms'] = update.message.text
    lang = context.user_data.get('lang', 'en')
    
    # In a real app, you would save this data to a database.
    # For now, we just confirm it to the user.
    confirmation_text = TEXTS[lang]['booking_confirmed'].format(
        name=context.user_data['booking_name'],
        age=context.user_data['booking_age'],
        symptoms=context.user_data['booking_symptoms']
    )
    await update.message.reply_text(confirmation_text)
    
    # Clean up user_data
    del context.user_data['booking_name']
    del context.user_data['booking_age']
    del context.user_data['booking_symptoms']
    
    await show_main_menu(update, context)
    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Cancels and ends the booking conversation."""
    lang = context.user_data.get('lang', 'en')
    await update.message.reply_text(TEXTS[lang]['booking_cancelled'])
    await show_main_menu(update, context)
    return ConversationHandler.END

def main() -> None:
    """Start the bot."""
    application = Application.builder().token(BOT_TOKEN).build()

    # Conversation handler for booking process
    conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex('^(üìÖ Book Tele-consultation|üìÖ ‡¶ü‡ßá‡¶≤‡¶ø-‡¶™‡ß∞‡¶æ‡¶Æ‡ß∞‡ßç‡¶∂ ‡¶¨‡ßÅ‡¶ï ‡¶ï‡ß∞‡¶ï)$'), book_start)],
        states={
            BOOKING_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, book_name)],
            BOOKING_AGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, book_age)],
            BOOKING_SYMPTOMS: [MessageHandler(filters.TEXT & ~filters.COMMAND, book_symptoms)],
        },
        fallbacks=[CommandHandler('cancel', cancel)],
    )

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(button_handler))
    application.add_handler(conv_handler)
    # These handlers need to be checked after the conversation handler
    application.add_handler(MessageHandler(filters.Regex('^(‚öïÔ∏è First-Aid Tips|‚öïÔ∏è ‡¶™‡ßç‡ß∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ)$'), first_aid))
    application.add_handler(MessageHandler(filters.Regex('^(üè• Find Nearby Hospital|üè• ‡¶ì‡¶ö‡ß∞‡ß∞ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶≤‡¶Ø‡¶º ‡¶¨‡¶ø‡¶ö‡¶æ‡ß∞‡¶ï)$'), find_hospital_start))
    application.add_handler(MessageHandler(filters.LOCATION, location_handler))
    
    print("Bot is running... Press Ctrl-C to stop.")
    application.run_polling()

if __name__ == '__main__':
    main()
